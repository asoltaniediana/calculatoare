<!DOCTYPE html>
<html lang="ro">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />

    <title>Calculator Dobanda Compusa</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --btn-bg-color: #ff4612;
        --btn-bg-hover: #ff4612;
        --text-color: #1e1e1e;
      }

      input[type="number"],
      input[type="text"],
      select,
      textarea {
        font-size: 16px;
      }

      body {
        font-family: "Source Sans Pro", sans-serif;
        background-color: #f9f9f9;
        margin: 0;
        padding: 0;
      }

      .calculator {
        max-width: 600px;
        margin: 20px auto;
        padding: 20px;
      }

      .calculator h1 {
        text-align: center;
        font-size: 24px;
        margin-bottom: 20px;
        color: var(--text-color);
      }

      .calculator label {
        display: block;
        margin-top: 16px;
        margin-bottom: 4px;
        font-weight: 600;
        color: var(--text-color);
      }

      input[type="number"],
      select {
        width: 100%;
        font-size: 16px;
        border-radius: 4px;
        border: 1px solid #ccc;
        padding: 10px;
        box-sizing: border-box;
        font-family: "Source Sans Pro", sans-serif;
      }

      button {
        background-color: var(--btn-bg-color);
        color: #fff;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s ease;
        font-size: 16px;
        border-radius: 6px;
        padding: 10px 20px;
        margin: 20px auto 0;
        display: block;
      }

      button:hover {
        background-color: var(--btn-bg-hover);
      }

      .rezultate {
        max-width: 600px;
        margin: 30px auto 10px;
        padding: 0 20px;
      }

      .rezultate h2 {
        color: var(--text-color);
        font-size: 20px;
        margin-bottom: 12px;
        text-align: center;
        border-bottom: 2px solid #ff4612;
        padding-bottom: 6px;
      }

      .rezultate p {
        font-size: 17px;
        color: var(--text-color);
        margin: 8px 0;
        text-align: center;
      }

      #chart-container {
        max-width: 600px;
        margin: 20px auto;
        padding: 0 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 15px;
      }

      th,
      td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
      }

      th {
        background-color: #f0f0f0;
        color: var(--text-color);
      }

      @media (max-width: 480px) {
        .calculator,
        .rezultate {
          padding: 15px;
          margin: 10px;
        }

        input[type="number"],
        select,
        button {
          font-size: 14px;
          padding: 8px;
        }

        table {
          font-size: 13px;
        }
      }
    </style>
  </head>
  <body>
    <div class="calculator">
      <h1>Calculator Dobanda Compusa</h1>

      <form id="formularDobandaCompusa" novalidate>
        <label for="principal">Suma initiala (RON):</label>
        <input type="number" id="principal" min="0" step="0.01" value="1000" />

        <label for="rataAnuala">Dobanda anuala (%):</label>
        <input type="number" id="rataAnuala" min="0" step="0.01" value="4" />

        <label for="compuneriPeAn">Compuneri pe an:</label>
        <select id="compuneriPeAn">
          <option value="1">Anual</option>
          <option value="2">Semestrial</option>
          <option value="4" selected>Trimestrial</option>
          <option value="12">Lunar</option>
        </select>

        <label for="ani">Numar de ani:</label>
        <input type="number" id="ani" min="0" step="0.1" value="5" />

        <label for="contributiePeriodica"
          >Contributie periodica (optional):</label
        >
        <input
          type="number"
          id="contributiePeriodica"
          min="0"
          step="0.01"
          value="100"
        />

        <label for="frecventaContributie">Frecventa contributiei:</label>
        <select id="frecventaContributie">
          <option value="1">Anual</option>
          <option value="2">Semestrial</option>
          <option value="4" selected>Trimestrial</option>
          <option value="12">Lunar</option>
        </select>

        <button type="submit">CALCULEAZA</button>
      </form>

      <div
        id="selectorRaportareContainer"
        style="display: none; margin-top: 20px"
      >
        <label for="selectorRaportare">Afisare rezultate:</label>
        <select id="selectorRaportare">
          <option value="anual" selected>Anual</option>
          <option value="lunar">Lunar</option>
        </select>
      </div>
    </div>

    <div class="rezultate" id="rezultate" style="display: none">
      <h2>Rezultate</h2>
      <p id="rezultatText"></p>
    </div>

    <div class="rezultate" id="chart-container" style="display: none">
      <canvas id="chart"></canvas>
    </div>

    <div
      class="rezultate"
      id="tabelRezultat"
      style="display: none; overflow-x: auto"
    >
      <table>
        <thead>
          <tr>
            <th>Perioada</th>
            <th>Suma investita (RON)</th>
            <th>Dobanda acumulata (RON)</th>
            <th>Suma totala (RON)</th>
          </tr>
        </thead>
        <tbody id="tabelBody"></tbody>
      </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const form = document.getElementById("formularDobandaCompusa");
      const rezultatText = document.getElementById("rezultatText");
      const tabelRezultat = document.getElementById("tabelRezultat");
      const tabelBody = document.getElementById("tabelBody");
      const chartContainer = document.getElementById("chart-container");
      const selectorRaportareContainer = document.getElementById(
        "selectorRaportareContainer"
      );
      const selectorRaportare = document.getElementById("selectorRaportare");
      const rezultateDiv = document.getElementById("rezultate");

      let chartInstance = null;
      let calcParams = null;

      function calculeazaEvolutie(
        P,
        r,
        n,
        t,
        PMT = 0,
        pmtFreq = 1,
        raportare = "anual"
      ) {
        const rezultate = [];
        const luniTotale = Math.round(t * 12);

        let sumaInvestita = P;
        let valoareCont = P;

        const intervalCompunere = 12 / n; // luni între compuneri dobândă
        const intervalContributie = 12 / pmtFreq; // luni între contribuții

        for (let luna = 0; luna <= luniTotale; luna++) {
          // Adaugă contribuție doar la lunile corespunzătoare
          if (PMT > 0 && luna > 0 && luna % intervalContributie === 0) {
            valoareCont += PMT;
            sumaInvestita += PMT;
          }

          // Aplică dobânda doar la lunile corespunzătoare compunerii
          if (luna > 0 && luna % intervalCompunere === 0) {
            valoareCont += valoareCont * (r / n);
          }

          rezultate.push({ luna, valoare: valoareCont, sumaInvestita });
        }

        // Pregătim rezultatele pentru afișare în funcție de raportare (anual sau lunar)
        const rezultateFinale = [];

        if (raportare === "anual") {
          const ani = Math.ceil(t);
          for (let an = 0; an <= ani; an++) {
            let lunaIndex = an * 12;
            if (lunaIndex >= rezultate.length) lunaIndex = rezultate.length - 1;
            const val = rezultate[lunaIndex];
            rezultateFinale.push({
              perioada: an + " ani",
              sumaInvestita: val.sumaInvestita,
              dobandaAcumulata: val.valoare - val.sumaInvestita,
              total: val.valoare,
            });
          }
        } else {
          for (let i = 0; i < rezultate.length; i++) {
            const val = rezultate[i];
            rezultateFinale.push({
              perioada: i + " luni",
              sumaInvestita: val.sumaInvestita,
              dobandaAcumulata: val.valoare - val.sumaInvestita,
              total: val.valoare,
            });
          }
        }

        return rezultateFinale;
      }

      function afiseazaRezultate(rezultate) {
        tabelBody.innerHTML = "";
        rezultate.forEach((rz) => {
          tabelBody.innerHTML += `
            <tr>
              <td style="text-align:left">${rz.perioada}</td>
              <td>${rz.sumaInvestita.toLocaleString("ro-RO", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              })}</td>
              <td>${rz.dobandaAcumulata.toLocaleString("ro-RO", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              })}</td>
              <td>${rz.total.toLocaleString("ro-RO", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              })}</td>
            </tr>`;
        });
        tabelRezultat.style.display = "block";
        rezultateDiv.style.display = "block";
      }

      function afiseazaGrafic(rezultate) {
        const etichete = rezultate.map((rz) => rz.perioada);
        const investitieData = rezultate.map((rz) => rz.sumaInvestita);
        const dobandaData = rezultate.map((rz) => rz.dobandaAcumulata);

        if (chartInstance) chartInstance.destroy();
        const ctx = document.getElementById("chart").getContext("2d");

        chartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: etichete,
            datasets: [
              {
                label: "Investitie",
                data: investitieData,
                backgroundColor: "#faa61a",
                stack: "stack1",
              },
              {
                label: "Dobanda acumulata",
                data: dobandaData,
                backgroundColor: "#ff4612",
                stack: "stack1",
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "top" },
              tooltip: {
                callbacks: {
                  label: (ctx) =>
                    ctx.dataset.label +
                    ": " +
                    ctx.parsed.y.toLocaleString("ro-RO", {
                      minimumFractionDigits: 2,
                      maximumFractionDigits: 2,
                    }),
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
        chartContainer.style.display = "block";
      }

      function afiseazaTot() {
        const rezultate = calculeazaEvolutie(
          ...calcParams,
          selectorRaportare.value
        );
        afiseazaRezultate(rezultate);
        afiseazaGrafic(rezultate);

        const ultimulRezultat = rezultate[rezultate.length - 1];
        const ani = calcParams[3];

        rezultatText.innerHTML = `
    <p>Suma totală după <strong>${ani} ani</strong>: <strong>${ultimulRezultat.total.toLocaleString(
          "ro-RO",
          {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          }
        )} RON</strong></p>
    <p>Sumă contribuită: <strong>${ultimulRezultat.sumaInvestita.toLocaleString(
      "ro-RO",
      {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      }
    )} RON</strong></p>
    <p>Dobândă acumulată: <strong>${ultimulRezultat.dobandaAcumulata.toLocaleString(
      "ro-RO",
      {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      }
    )} RON</strong></p>
  `;
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        let P = parseFloat(form.principal.value);
        let r = parseFloat(form.rataAnuala.value) / 100;
        let n = parseInt(form.compuneriPeAn.value);
        let t = parseFloat(form.ani.value);
        let PMT = parseFloat(form.contributiePeriodica.value) || 0;
        let pmtFreq = parseInt(form.frecventaContributie.value);

        if (
          isNaN(P) ||
          isNaN(r) ||
          isNaN(n) ||
          isNaN(t) ||
          P < 0 ||
          r < 0 ||
          n <= 0 ||
          t < 0 ||
          PMT < 0
        ) {
          alert("Te rog sa completezi corect toate campurile.");
          return;
        }

        calcParams = [P, r, n, t, PMT, pmtFreq];
        selectorRaportareContainer.style.display = "block";
        afiseazaTot();
      });

      selectorRaportare.addEventListener("change", afiseazaTot);
    </script>
  </body>
</html>
